<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student - Bus Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/static/main.css" />
</head>
<body>
  <header id="header">
    <div class="status-bar">
      <div class="status-main">
        <span id="statusText">At </span>
        <span id="curr" class="highlight">...</span>
        <span id="nextStop"></span>
        <span id="gpsIndicator" class="gps-indicator" style="display: none;">üìç Live</span>
      </div>
      <span id="lastUpdate" class="timestamp-badge">--:--</span>
    </div>
    <a href="/logout" class="logout-btn" title="Logout">
      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px;">
        <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
      </svg>
    </a>
  </header>
  <div id="map"></div>
  <div class="actions">
    <button id="arrivedBtn" class="btn">ARRIVED</button>
    <button id="shareLocationBtn" class="location-btn" title="Share Location">
      <svg viewBox="0 0 24 24" style="transform: translateY(1px)">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zM12 6.5l2.5 2.5h-2v3h-1v-3h-2L12 6.5z"/>
      </svg>
    </button>
    <button id="centerBusBtn" class="center-btn" title="Center on Bus">
      <svg viewBox="0 0 24 24">
        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
      </svg>
    </button>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <style>
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 2000;
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
    }

    /* Center on bus button */
    .center-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #ddd;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .center-btn:active {
      transform: scale(0.95);
      background: #f0f0f0;
    }

    .center-btn svg {
      width: 24px;
      height: 24px;
      fill: #333;
    }

    /* GPS indicator badge */
    .gps-indicator {
      background: #34c759;
      color: #fff;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
      display: inline-block;
    }

    /* Logout button - floating in top-right */
    .logout-btn {
      position: fixed;
      top: 80px;
      right: 16px;
      width: 44px;
      height: 44px;
      background: #fff;
      border: 2px solid #ddd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 1000;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #f0f0f0;
    }

    .logout-btn:active {
      transform: scale(0.95);
    }

    .logout-btn svg {
      fill: #333;
    }

    /* Location sharing button styles */
    .location-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #ff3b30;
      border: none;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .location-btn:active {
      transform: scale(0.95);
    }

    .location-btn.active {
      background: #34c759;
    }

    .location-btn:disabled {
      background: #999;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .location-btn svg {
      width: 28px;
      height: 28px;
      fill: #000;
    }

    /* Updated actions container - reduced spacing */
    .actions {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #fff;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      min-height: 76px;
      box-sizing: border-box;
    }

    .actions .btn {
      flex: 1;
      max-width: 280px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      border: none;
      border-radius: 24px;
      background: #3b82f6;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }

    .actions .btn:active {
      transform: scale(0.98);
    }
  </style>

  <script>
    const POLL_MS = 1000;
    const BUS_ID = "{{ bus_id }}";
    const STUDENT_ID = 'S1';

    // Show toast notification
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }

    let locationWatchId = null;
    let studentLocationAllowed = false;

    function handleLocationError(error) {
      console.error('Error getting location:', error);
      const btn = document.getElementById('shareLocationBtn');
      btn.classList.remove('active');
      showToast('Could not get location. Please check GPS settings.');
    }

    function shareLocation(position) {
      const { latitude, longitude, accuracy } = position.coords;
      
      fetch('/location/share', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          bus_id: BUS_ID,
          lat: latitude,
          lon: longitude,
          accuracy: accuracy
        })
      }).then(async r => {
        const state = await r.json();
        if (r.status === 403) {
          // Student location sharing was disabled
          console.log('Student location sharing disabled by driver');
          stopLocationSharing();
          showToast('Location sharing disabled by driver');
          checkStudentLocationStatus(); // Refresh status
        } else if (state.error) {
          console.error('Location share error:', state.error);
        }
      }).catch(error => {
        console.error('Error sharing location:', error);
      });
    }

    function stopLocationSharing() {
      if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
        document.getElementById('shareLocationBtn').classList.remove('active');
      }
    }

    // Check if student location sharing is enabled
    function checkStudentLocationStatus() {
      fetch(`/student/location-status?bus_id=${encodeURIComponent(BUS_ID)}`)
        .then(r => r.json())
        .then(data => {
          studentLocationAllowed = data.enabled || false;
          updateLocationButtonState();
        })
        .catch(err => console.error('Error checking location status:', err));
    }

    function updateLocationButtonState() {
      const btn = document.getElementById('shareLocationBtn');
      if (!studentLocationAllowed) {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
        btn.title = 'Location sharing disabled by driver';
        stopLocationSharing();
      } else {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.title = 'Share Location';
      }
    }

    // Location sharing button
    document.getElementById('shareLocationBtn').addEventListener('click', function() {
      if (!studentLocationAllowed) {
        showToast('Location sharing is disabled');
        return;
      }
      
      if (!locationWatchId) {
        // Start sharing location
        if ("geolocation" in navigator) {
          this.classList.add('active');
          showToast('GPS Tracking Started');
          
          // Get initial position
          navigator.geolocation.getCurrentPosition(shareLocation, handleLocationError, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          });
          
          // Set up continuous watching
          locationWatchId = navigator.geolocation.watchPosition(shareLocation, handleLocationError, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 1000
          });
        } else {
          showToast('Geolocation not supported');
        }
      } else {
        // Stop sharing location
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
        this.classList.remove('active');
        showToast('GPS Tracking Stopped');
      }
    });
  </script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    // Center on bus button
    document.getElementById('centerBusBtn').addEventListener('click', function() {
      if (busMarker) {
        const pos = busMarker.getLatLng();
        map.flyTo(pos, 16, {
          duration: 1.0,
          easeLinearity: 0.5
        });
      }
    });
    // Create custom bus icon
    const busIcon = L.divIcon({ 
      html: `<div style="font-size: 36px; text-align: center;">üöå</div>`,
      className: 'bus-marker',
      iconSize: [48, 48],
      iconAnchor: [24, 24]
    });

    // Style for bus marker
    const style = document.createElement('style');
    style.textContent = `
      .bus-marker {
        background: #4a90e2;
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      }
    `;
    document.head.appendChild(style);

    let busMarker = null;
    let stops = [];
    let stopMarkers = [];

    // Initialize stops and create markers
    fetch('/stops').then(r=>r.json()).then(data => {
      stops = data;
      const pts = stops.map(s => [s.lat, s.lon]);
      
      // Create stop markers
      stops.forEach((s, i) => {
        const marker = L.marker([s.lat, s.lon])
          .addTo(map)
          .bindPopup(s.name);
        stopMarkers.push(marker);
      });

      if (pts.length) {
        map.fitBounds(pts, { padding: [30,30] });
      }

      // Create bus marker at the first stop
      if (stops.length > 0) {
        const firstStop = stops[0];
        busMarker = L.marker([firstStop.lat, firstStop.lon], {
          icon: busIcon,
          zIndexOffset: 1000 // Keep bus marker above stop markers
        }).addTo(map);
      }
    });

    function namesFor(state) {
      const idx = state.stop_index || 0;
      const curr = stops.find(s => s.seq === idx);
      const next = stops.length ? stops[Math.min(idx + 1, stops.length - 1)] : null;
      return { currName: curr ? curr.name : 'Unknown', nextName: next ? next.name : '' };
    }

    function loadState() {
      fetch(`/bus/${BUS_ID}`).then(r=>r.json()).then(state => {
        const isMoving = state.status === 'departing';
        const { currName, nextName } = namesFor(state);
        
        // Update status text and stop name
        document.getElementById('statusText').textContent = isMoving ? 'Moving to ' : 'At ';
        document.getElementById('curr').textContent = isMoving ? nextName : currName;
        document.getElementById('nextStop').textContent = '';
        
        // Update timestamp in HH:MM format
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ':' + 
                    now.getMinutes().toString().padStart(2, '0');
        document.getElementById('lastUpdate').textContent = time;
        
        // Update bus position from GPS coordinates (no auto-centering)
        if (state.lat && state.lon && busMarker) {
          busMarker.setLatLng([state.lat, state.lon]);
        }

        if (state.stop_id) updateCount(state.stop_id);
      }).catch(()=>{});
    }

    function updateCount(stop_id) {
      const el = document.getElementById('cnt');
      if (!el) return;
      fetch(`/confirmations?bus_id=${BUS_ID}&stop_id=${stop_id}`).then(r=>r.json()).then(x => {
        el.textContent = x.confirmations;
      }).catch(()=>{});
    }

    function checkGPSStatus() {
      fetch(`/gps/status?bus_id=${encodeURIComponent(BUS_ID)}`)
        .then(r => r.json())
        .then(data => {
          const indicator = document.getElementById('gps-indicator');
          if (data.gps_active) {
            indicator.style.display = 'inline-block';
          } else {
            indicator.style.display = 'none';
          }
        })
        .catch(err => console.error('GPS check error:', err));
    }

    document.getElementById('arrivedBtn').onclick = () => {
      fetch('/student/arrived', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ bus_id: BUS_ID, student_id: STUDENT_ID })
      }).then(r => r.json()).then(resp => {
        // Show feedback based on GPS status
        if (resp.gps_active && !resp.moved) {
          showToast('Confirmation recorded - GPS tracking active');
        } else if (resp.moved) {
          showToast('Bus moved to next stop');
        } else {
          showToast('Confirmation recorded');
        }
        
        // Update confirmation count and state
        if (resp.state && resp.state.stop_id) updateCount(resp.state.stop_id);
        loadState();
      }).catch(error => {
        console.error('Error:', error);
        showToast('Error recording confirmation');
      });
    };

    loadState();
    setInterval(loadState, POLL_MS);
    
    // Check GPS status periodically (every 5 seconds)
    checkGPSStatus();
    setInterval(checkGPSStatus, 5000);
    
    // Check student location sharing status periodically (every 3 seconds)
    checkStudentLocationStatus();
    setInterval(checkStudentLocationStatus, 3000);
  </script>
</body>
</html> 