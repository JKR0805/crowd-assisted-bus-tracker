<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Driver - Bus Tracker</title>
  <link rel="stylesheet" href="/static/main.css" />
  <style>
    .driver-info {
      padding: 20px;
      margin-top: 20px;
    }
    .info-box {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .info-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
    }
    .info-value {
      font-size: 24px;
      font-weight: 600;
      color: #111;
    }
    .info-value.highlight {
      color: #059669;
    }
    .status-bar {
      background: #ecfdf5;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .actions {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 20px;
      background: #fff;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
    }
    .btn {
      width: 100%;
      font-size: 20px;
      padding: 20px;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <div class="driver-info">
    <div class="status-bar">
      <div class="status-main">
        <span id="statusText">At </span>
        <span id="curr" class="highlight">...</span>
        <span id="lastUpdate" class="timestamp-badge">--:--</span>
      </div>
    </div>

    <div class="info-box">
      <div class="info-label">Next Stop</div>
      <div id="nextStop" class="info-value">...</div>
    </div>

    <!-- Logout Button directly below Next Stop -->
    <div style="margin-bottom: 16px;">
      <a href="/logout" class="logout-btn-full" title="Logout">
        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; margin-right: 8px;">
          <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
        </svg>
        Logout
      </a>
    </div>

    <!-- Student Location Toggle -->
    <div style="margin-bottom: 16px;">
      <button id="toggleStudentLocationBtn" class="toggle-btn" title="Toggle Student Location Sharing">
        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; margin-right: 8px;">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
        <span id="studentLocationStatus">Enable Student Location</span>
      </button>
    </div>

    <!-- Reset Button moved here below Student Location Toggle -->
    <div style="margin-bottom: 90px;">
      <button id="resetBtn" class="reset-btn-small" title="Reset Bus to Starting Stop">Reset Bus (Testing)</button>
    </div>
  </div>

  <div class="actions">
    <button id="departedBtn" class="btn">DEPARTED</button>
    <button id="shareLocationBtn" class="location-btn" title="Share Location">
      <svg viewBox="0 0 24 24" style="transform: translateY(1px)">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zM12 6.5l2.5 2.5h-2v3h-1v-3h-2L12 6.5z"/>
      </svg>
    </button>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <style>
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 2000;
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
    }

    /* Reset button styles - smaller and less prominent */
    .reset-btn-small {
      width: 100%;
      max-width: 100%;
      background: #e0e0e0;
      color: #666;
      border: 1px solid #ccc;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      cursor: pointer;
      box-sizing: border-box;
    }

    .reset-btn-small:active {
      transform: scale(0.98);
      background: #d0d0d0;
    }

    /* Logout button styles - full width button */
    .logout-btn-full {
      width: 100%;
      max-width: 100%;
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
      text-decoration: none;
      box-sizing: border-box;
    }

    .logout-btn-full:active {
      transform: scale(0.98);
      background: #c82333;
    }

    .logout-btn-full svg {
      fill: #fff;
    }

    /* Toggle button styles - student location control */
    .toggle-btn {
      width: 100%;
      max-width: 100%;
      background: #6c757d;
      color: #fff;
      border: none;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
      box-sizing: border-box;
    }

    .toggle-btn.enabled {
      background: #28a745;
    }

    .toggle-btn:active {
      transform: scale(0.98);
    }

    .toggle-btn svg {
      fill: #fff;
    }

    /* Location sharing button styles */
    .location-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #ff3b30;
      border: none;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .location-btn:active {
      transform: scale(0.95);
    }

    .location-btn.active {
      background: #34c759;
    }

    .location-btn svg {
      width: 28px;
      height: 28px;
      fill: #000;
    }

    /* Updated actions container - reduced spacing */
    .actions {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #fff;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      min-height: 76px;
      box-sizing: border-box;
    }

    .actions .btn {
      flex: 1;
      max-width: 280px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      border: none;
      border-radius: 24px;
      background: #3b82f6;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }

    .actions .btn:active {
      transform: scale(0.98);
    }
  </style>

  <script>
    const POLL_MS = 1000;
    const BUS_ID = "{{ bus_id }}";

    // Show toast notification
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }
  </script>
  <script>
    let locationWatchId = null;

    function handleLocationError(error) {
      console.error('Error getting location:', error);
      const btn = document.getElementById('shareLocationBtn');
      btn.classList.remove('active');
      showToast('Could not get location. Please check GPS settings.');
    }

    function shareLocation(position) {
      const { latitude, longitude, accuracy } = position.coords;
      
      fetch('/location/share', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          bus_id: BUS_ID,
          lat: latitude,
          lon: longitude,
          accuracy: accuracy
        })
      }).then(r => r.json()).then(state => {
        // Status updates are handled by the regular refresh function
        if (state.error) {
          console.error('Location share error:', state.error);
        } else {
          refresh();
        }
      }).catch(error => {
        console.error('Error sharing location:', error);
      });
    }

    document.getElementById('shareLocationBtn').addEventListener('click', function() {
      if (!locationWatchId) {
        // Start sharing location
        if ("geolocation" in navigator) {
          this.classList.add('active');
          showToast('GPS Tracking Started');
          
          // Get initial position
          navigator.geolocation.getCurrentPosition(shareLocation, handleLocationError, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          });
          
          // Set up continuous watching
          locationWatchId = navigator.geolocation.watchPosition(shareLocation, handleLocationError, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 1000
          });
        } else {
          showToast('Geolocation not supported');
        }
      } else {
        // Stop sharing location
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
        this.classList.remove('active');
        
        // Immediately notify server to enable manual controls
        fetch('/location/stop', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ bus_id: BUS_ID })
        }).then(r => r.json()).then(data => {
          showToast('GPS Tracking Stopped - Manual controls enabled');
          refresh();
        }).catch(error => {
          console.error('Error stopping GPS:', error);
          showToast('GPS Tracking Stopped');
        });
      }
    });

    // Reset button handler
    document.getElementById('resetBtn').addEventListener('click', function() {
      if (confirm('Reset bus to starting stop?')) {
        // Stop GPS if it's running
        if (locationWatchId) {
          navigator.geolocation.clearWatch(locationWatchId);
          locationWatchId = null;
          document.getElementById('shareLocationBtn').classList.remove('active');
        }
        
        fetch('/driver/reset', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ bus_id: BUS_ID })
        }).then(r => r.json()).then(state => {
          if (state.error) {
            showToast('Error: ' + state.error);
          } else {
            showToast('âœ“ Bus reset to start');
            refresh();
          }
        }).catch(error => {
          console.error('Reset error:', error);
          showToast('Reset failed');
        });
      }
    });

    // Student location toggle handler
    let studentLocationEnabled = false;
    document.getElementById('toggleStudentLocationBtn').addEventListener('click', function() {
      studentLocationEnabled = !studentLocationEnabled;
      
      fetch('/driver/toggle-student-location', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
          bus_id: BUS_ID,
          enabled: studentLocationEnabled
        })
      }).then(r => r.json()).then(data => {
        if (data.error) {
          showToast('Error: ' + data.error);
          studentLocationEnabled = !studentLocationEnabled; // Revert on error
        } else {
          updateStudentLocationUI();
          showToast(data.message);
        }
      }).catch(error => {
        console.error('Toggle error:', error);
        showToast('Failed to toggle student location');
        studentLocationEnabled = !studentLocationEnabled; // Revert on error
      });
    });

    // Update student location toggle UI
    function updateStudentLocationUI() {
      const btn = document.getElementById('toggleStudentLocationBtn');
      const status = document.getElementById('studentLocationStatus');
      
      if (studentLocationEnabled) {
        btn.classList.add('enabled');
        status.textContent = 'Disable Student Location';
      } else {
        btn.classList.remove('enabled');
        status.textContent = 'Enable Student Location';
      }
    }

    // Load initial student location status
    function loadStudentLocationStatus() {
      fetch(`/driver/student-location-status?bus_id=${encodeURIComponent(BUS_ID)}`)
        .then(r => r.json())
        .then(data => {
          studentLocationEnabled = data.student_location_enabled || false;
          updateStudentLocationUI();
        })
        .catch(err => console.error('Error loading student location status:', err));
    }

    function refresh() {
      fetch(`/bus/${BUS_ID}`).then(r=>r.json()).then(state => {
        // Update timestamp
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ':' + 
                    now.getMinutes().toString().padStart(2, '0');
        document.getElementById('lastUpdate').textContent = time;

        // Get current and next stop info
        fetch('/stops').then(r=>r.json()).then(stops => {
          const idx = state.stop_index || 0;
          const curr = stops.find(s => s.seq === idx);
          const next = stops.find(s => s.seq === Math.min(idx + 1, stops.length - 1));
          
          const currentStop = curr ? curr.name : 'Unknown';
          const nextStop = next ? next.name : '-';
          const isMoving = state.status === 'departing';

          // Update status display
          document.getElementById('statusText').textContent = isMoving ? 'Moving to ' : 'At ';
          document.getElementById('curr').textContent = isMoving ? nextStop : currentStop;
          
          // Update Next Stop info box only
          document.getElementById('nextStop').textContent = nextStop;
        });

        // Update status banner appearance
        const banner = document.querySelector('.status-banner');
        banner.classList.toggle('moving', state.status === 'departing');
        
        if (state.lat == null || state.lon == null) return;
        if (!busMarker) {
          busMarker = L.marker([state.lat, state.lon], { 
            icon: L.divIcon({
              html: 'ðŸšŒ',
              className: `bus-marker-icon ${state.status === 'departing' ? 'moving' : 'stopped'}`,
              iconSize: [56, 56],
              iconAnchor: [28, 28]
            })
          }).addTo(map);
          map.setView([state.lat, state.lon]);
        } else {
          busMarker.setIcon(L.divIcon({
            html: 'ðŸšŒ',
            className: `bus-marker-icon ${state.status === 'departing' ? 'moving' : 'stopped'}`,
            iconSize: [56, 56],
            iconAnchor: [28, 28]
          }));
          if (lastLat !== state.lat || lastLon !== state.lon) {
            busMarker.setLatLng([state.lat, state.lon]);
            map.setView([state.lat, state.lon]);
          }
        }
        lastLat = state.lat; lastLon = state.lon;
      }).catch(()=>{});
    }

    document.getElementById('departedBtn').onclick = () => {
      fetch('/driver/departed', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ bus_id: BUS_ID })
      }).then(async r => {
        const resp = await r.json();
        if (r.status === 400 && resp.gps_active) {
          // GPS is blocking manual control
          showToast('âš ï¸ Turn off GPS tracking first');
        } else if (resp.error) {
          showToast(resp.message || resp.error);
        } else {
          showToast('Departed');
          refresh();
        }
      }).catch(error => {
        console.error('Departed error:', error);
        showToast('Error - please try again');
      });
    };

    // Initialize
    loadStudentLocationStatus();
    refresh();
    setInterval(refresh, POLL_MS);
  </script>
</body>
</html> 